<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Card Theft (SquareCTF 2021) Writeup</title>
<script src="../../../../common/common.js"></script>
</head>
<body>
<language-selector data-langlist="日本語,ja,English,en"></language-selector>
<h1>Card Theft</h1>
<span class="language-selector-ja" lang="ja">
<p>
TCPサーバの接続情報とELFファイル <code>card-theft</code> が与えられ、クレジットカードの番号を要求された。
</p><p>
このELFファイルを<common-tool data-lang="ja">Ghidra</common-tool>で逆コンパイルすると、以下のことがわかった。
</p>
<ul>
<li><code>main</code>関数は、以下のことをしている。
<ol>
<li>データ <code>5a 08 11 22 33 44 55 66 77 88 42 02 11 22</code> を <code>process_emv</code>関数で処理する。</li>
<li>無限ループで以下の処理を行う。
<ol>
<li>16進数で表現されたデータを読み込む。</li>
<li>それをデコードし、<code>process_emv</code>関数で処理する。</li>
</ol></li>
</ol></li>
<li><code>process_emv</code>関数は、データを<code>process_tlv</code>関数で処理している。</li>
<li><code>process_tlv</code>関数は、以下のことをしている。
<ol>
<li>データの先頭からタグを読み取る。</li>
<li>タグがあらかじめ決められたリストに無いものなら、この関数の処理を終了する。</li>
<li>データの続きから長さの情報を読み取る。</li>
<li>長さの情報の次のデータ、読み取った長さの情報、バッファサイズを以下の関数に渡し、データを処理させる。
<ul>
<li>タグが <code>0x42</code> のとき、<code>read_iin</code>関数</li>
<li>タグが <code>0x5a</code> のとき、<code>read_pan</code>関数</li>
<li>タグがリストにあるそれ以外のもののとき、<code>read_value</code>関数</li>
</ul></li>
</ol></li>
<li><code>read_pan</code>関数は、<code>copy_data</code>関数でデータを配列<code>pan</code>にコピーし、その最後の2要素を出力している。</li>
<li><code>copy_data</code>関数は、バッファサイズを参照し、バッファの範囲内からのみコピーを行う。</li>
</ul>
<p>
<code>copy_data</code>関数の仕様より、実際に与えるデータより長さの情報を長く設定すると、以前に配列<code>pan</code>にコピーされたデータがそのまま出力される。<br>
以下のように、長さの情報を適宜設定していくことで後ろの6バイトの情報は得られたが、長さの情報を4バイト未満に設定すると拒否されるので、最初の2バイトは得られなかった。
</p>
</span>
<span class="language-selector-en" lang="en">
<p>
Information to connect to a TCP server, and an ELF file <code>card-theft</code> were given, and the credit card number was asked.
</p><p>
Decompiling this ELF file using <common-tool data-lang="en">Ghidra</common-tool>, I found these things:
</p>
<ul>
<li>What the function <code>main</code> does is:
<ol>
<li>Process data <code>5a 08 11 22 33 44 55 66 77 88 42 02 11 22</code> with the function <code>process_emv</code>.</li>
<li>Do these steps in an infinite loop:
<ol>
<li>Read data represented in hexadecimal.</li>
<li>Decode the data and process it with the function <code>process_emv</code>.</li>
</ol></li>
</ol></li>
<li>The function <code>process_emv</code> processes the data with the function <code>process_tlv</code>.</li>
<li>What the function <code>process_tlv</code> is:
<ol>
<li>Read a tag from the beginning of the data.</li>
<li>If the tag doesn't exist in a pre-defined list, exit from this function.</li>
<li>Read length information from the data after the tag.</li>
<li>Have these functions process the data, passing data next to the length information, the length information read, and the size of the buffer:
<ul>
<li>The function <code>read_iin</code> for the tag <code>0x42</code></li>
<li>The function <code>read_pan</code> for the tag <code>0x5a</code></li>
<li>The function <code>read_value</code> for the other tags</li>
</ul></li>
</ol></li>
<li>The function <code>read_pan</code> copies data to an array <code>pan</code> via the function <code>copy_data</code>, and prints the last 2 elements.</li>
<li>The function <code>copy_data</code> copies data from only the valid range of the buffer referring the buffer size.</li>
</ul>
<p>
Due to the behavior of the function <code>copy_data</code>, when the length information is set to longer than data actually given, data previously copied to the array <code>pan</code> is printed.<br>
I obtained the 6 bytes from the tail by setting the length information properly in this way, but the first 2 bytes weren't available because it refuses to process length information less than 4 bytes.
</p>
</span>
<p><a href="log.txt" class="code-link" data-collapse="true">log.txt</a></p>

<p class="language-selector-ja" lang="ja">
ここで、ファイル <code>card-theft</code> に埋め込まれているデータを見ると、PANの最初の2バイトはIINと同じに設定されていることに気がついた。<br>
そこで、とりあえず残りの2バイトにIINの値を入れてみると、正解になり、flagが得られた。
</p>
<p class="language-selector-en" lang="en">
Seeing the data embed in the file <code>card-theft</code>, I found that the first 2 bytes of PAN is set to the same as the IIN.<br>
I tried setting the 2 bytes left to the IIN. As a result, it was accepted and I obtained the flag.
</p>

<div class="flag">flag{4147403950091074}</div>
<hr>
<writeup-by></writeup-by>
<p>
<a href="../../" class="language-aware-link">SquareCTF 2021</a>
</p>
</body>
</html>
